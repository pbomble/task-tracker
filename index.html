<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Team Task & Leave Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f8fc;
        }
        .modal {
            display: none;
            transition: opacity 0.3s ease;
        }
        .modal.active {
            display: flex;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
            animation: fadeIn 0.5s;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .task-grid {
            display: grid;
            grid-template-columns: minmax(160px, 1fr) repeat(7, minmax(220px, 2fr));
            min-width: 1400px;
        }
        .grid-header {
            position: sticky;
            top: 0;
            z-index: 10;
        }
        .assignee-cell {
            position: sticky;
            left: 0;
            z-index: 11;
        }
        .task-card {
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .task-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body class="antialiased text-slate-800">

    <div id="app-container" class="p-4 sm:p-6 lg:p-8 max-w-full mx-auto">
        <!-- Header -->
        <header class="mb-8 flex flex-col sm:flex-row justify-between items-start sm:items-center">
            <div>
                <h1 class="text-3xl font-bold text-slate-900">Team Task & Leave Tracker</h1>
                <p class="text-slate-500 mt-1">Your team's central hub for tasks and availability.</p>
            </div>
            <div class="mt-4 sm:mt-0 flex items-start space-x-4">
                 <button id="manageTeamBtn" class="bg-white text-slate-600 hover:bg-slate-50 font-semibold py-2 px-4 rounded-lg shadow-sm border border-slate-200 transition-colors">
                    <i class="fas fa-users mr-2"></i>Manage Team
                </button>
                <div class="text-sm bg-white p-3 rounded-lg shadow-sm border border-slate-200">
                    <p class="text-slate-500 font-medium">Your User ID:</p>
                    <div class="flex items-center mt-1">
                        <span id="userIdDisplay" class="font-mono bg-slate-100 text-indigo-600 px-3 py-1 rounded-md font-semibold"></span>
                        <button id="editUserIdBtn" class="ml-2 text-slate-400 hover:text-indigo-600 transition-colors"><i class="fas fa-pencil-alt"></i></button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Tabs -->
        <div class="mb-6">
            <div class="border-b border-slate-200">
                <nav class="-mb-px flex space-x-6" aria-label="Tabs">
                    <button class="tab-button active-tab group inline-flex items-center py-4 px-1 border-b-2 font-semibold text-sm text-indigo-600 border-indigo-500" data-tab="tasks">
                        <i class="fas fa-table-list mr-2 text-indigo-500"></i>Weekly Tasks
                    </button>
                    <button class="tab-button group inline-flex items-center py-4 px-1 border-b-2 font-semibold text-sm text-slate-500 border-transparent hover:text-slate-700 hover:border-slate-300" data-tab="leaves">
                        <i class="fas fa-calendar-alt mr-2 text-slate-400 group-hover:text-slate-500"></i>Leave Planner
                    </button>
                </nav>
            </div>
        </div>

        <!-- Tab Content -->
        <main>
            <!-- Tasks Tab -->
            <div id="tasks-content" class="tab-content active">
                <div class="flex flex-col sm:flex-row justify-between items-center mb-6">
                    <div class="flex items-center space-x-2">
                         <button id="prevWeekBtn" class="p-2 rounded-full hover:bg-slate-200 transition-colors"><i class="fas fa-chevron-left"></i></button>
                         <h2 id="weekRangeDisplay" class="text-lg font-semibold text-slate-700 w-48 text-center"></h2>
                         <button id="nextWeekBtn" class="p-2 rounded-full hover:bg-slate-200 transition-colors"><i class="fas fa-chevron-right"></i></button>
                         <button id="exportExcelBtn" class="ml-4 bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg shadow-md text-sm transition-transform transform hover:scale-105">
                            <i class="fas fa-file-excel mr-2"></i>Export
                        </button>
                    </div>
                    <button id="addTaskBtn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg shadow-lg shadow-indigo-500/30 transition-transform transform hover:scale-105 mt-4 sm:mt-0">
                        <i class="fas fa-plus mr-2"></i>Add New Task
                    </button>
                </div>
                <div class="overflow-x-auto bg-white rounded-xl shadow-md">
                     <div id="taskGrid" class="task-grid">
                        <!-- Task grid will be dynamically inserted here -->
                     </div>
                </div>
                 <div id="no-tasks-message" class="hidden text-center py-20">
                    <i class="fas fa-folder-open text-5xl text-slate-300"></i>
                    <p class="mt-4 text-xl font-semibold text-slate-600">No tasks for this week.</p>
                    <p class="text-sm text-slate-400">Click "Add New Task" to get started!</p>
                </div>
            </div>

            <!-- Leaves Tab -->
            <div id="leaves-content" class="tab-content">
                 <div class="flex justify-end mb-6 space-x-3">
                    <button id="exportLeavesBtn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg shadow-md text-sm transition-transform transform hover:scale-105">
                        <i class="fas fa-file-excel mr-2"></i>Export Month
                    </button>
                    <button id="addLeaveBtn" class="bg-teal-500 hover:bg-teal-600 text-white font-bold py-2 px-4 rounded-lg shadow-lg shadow-teal-500/30 transition-transform transform hover:scale-105">
                        <i class="fas fa-plus mr-2"></i>Add Leave Plan
                    </button>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-md">
                    <div class="flex justify-between items-center mb-4">
                        <button id="prevMonthBtn" class="p-2 rounded-full hover:bg-slate-100"><i class="fas fa-chevron-left"></i></button>
                        <h2 id="currentMonthYear" class="text-xl font-semibold"></h2>
                        <button id="nextMonthBtn" class="p-2 rounded-full hover:bg-slate-100"><i class="fas fa-chevron-right"></i></button>
                    </div>
                    <div id="leaveCalendar" class="grid grid-cols-7 gap-1 text-center">
                       <!-- Calendar will be dynamically inserted here -->
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modals -->
    <!-- Task Modal -->
    <div id="taskModal" class="modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center z-50 p-4">
        <div class="bg-white rounded-xl shadow-2xl p-8 w-full max-w-lg m-4 transform transition-transform scale-95">
            <h2 id="taskModalTitle" class="text-2xl font-bold mb-6 text-slate-800">Add New Task</h2>
            <form id="taskForm">
                <input type="hidden" id="taskId">
                <div class="mb-5">
                    <label for="taskDescription" class="block text-slate-600 text-sm font-bold mb-2">Task Description</label>
                    <textarea id="taskDescription" rows="3" class="shadow-sm appearance-none border border-slate-300 rounded-lg w-full py-2 px-3 text-slate-700 leading-tight focus:outline-none focus:ring-2 focus:ring-indigo-500" required></textarea>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-5">
                    <div>
                        <label for="taskDate" class="block text-slate-600 text-sm font-bold mb-2">Date</label>
                        <input type="date" id="taskDate" class="shadow-sm appearance-none border border-slate-300 rounded-lg w-full py-2 px-3 text-slate-700 leading-tight focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
                    </div>
                    <div>
                         <label for="taskCategory" class="block text-slate-600 text-sm font-bold mb-2">Category</label>
                        <select id="taskCategory" class="shadow-sm border border-slate-300 rounded-lg w-full py-2 px-3 text-slate-700 leading-tight focus:outline-none focus:ring-2 focus:ring-indigo-500">
                            <option>Task</option>
                            <option>Automation</option>
                            <option>New TCs</option>
                            <option>Rework TCs</option>
                            <option>Meeting</option>
                        </select>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                    <div>
                        <label for="taskAssignee" class="block text-slate-600 text-sm font-bold mb-2">Assign To</label>
                        <select id="taskAssignee" class="shadow-sm appearance-none border border-slate-300 rounded-lg w-full py-2 px-3 text-slate-700 leading-tight focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
                           <!-- Options will be populated by JS -->
                        </select>
                    </div>
                    <div>
                        <label for="taskStatus" class="block text-slate-600 text-sm font-bold mb-2">Status</label>
                        <select id="taskStatus" class="shadow-sm border border-slate-300 rounded-lg w-full py-2 px-3 text-slate-700 leading-tight focus:outline-none focus:ring-2 focus:ring-indigo-500">
                            <option value="To Do">To Do</option>
                            <option value="In Progress">In Progress</option>
                            <option value="Done">Done</option>
                        </select>
                    </div>
                </div>
                <div class="flex items-center justify-end space-x-3">
                    <button type="button" id="cancelTask" class="bg-slate-100 hover:bg-slate-200 text-slate-700 font-bold py-2 px-4 rounded-lg transition-colors">Cancel</button>
                    <button type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg shadow-lg shadow-indigo-500/30">Save Task</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Team Management Modal -->
    <div id="teamModal" class="modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center z-50 p-4">
        <div class="bg-white rounded-xl shadow-2xl p-8 w-full max-w-md m-4 transform transition-transform scale-95">
            <h2 class="text-2xl font-bold mb-6 text-slate-800">Manage Team Members</h2>
            <div class="mb-4">
                <form id="addTeamMemberForm" class="flex space-x-2">
                    <input type="text" id="newTeamMemberName" placeholder="Enter new member's name" class="flex-grow shadow-sm appearance-none border border-slate-300 rounded-lg w-full py-2 px-3 text-slate-700 leading-tight focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
                    <button type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg shadow-md">Add</button>
                </form>
            </div>
            <div id="teamMemberList" class="space-y-2 max-h-60 overflow-y-auto pr-2">
                <!-- Team members will be listed here -->
            </div>
            <div class="flex justify-end mt-6">
                 <button type="button" id="closeTeamModal" class="bg-slate-100 hover:bg-slate-200 text-slate-700 font-bold py-2 px-4 rounded-lg transition-colors">Close</button>
            </div>
        </div>
    </div>

    <!-- Leave Modal -->
    <div id="leaveModal" class="modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center z-50 p-4">
        <div class="bg-white rounded-xl shadow-2xl p-8 w-full max-w-lg m-4 transform transition-transform scale-95">
            <h2 class="text-2xl font-bold mb-6 text-slate-800">Plan Leave</h2>
            <form id="leaveForm">
                <div class="mb-5">
                    <label for="leaveReason" class="block text-slate-600 text-sm font-bold mb-2">Reason (e.g., Vacation, Sick Leave)</label>
                    <input type="text" id="leaveReason" class="shadow-sm appearance-none border border-slate-300 rounded-lg w-full py-2 px-3 text-slate-700 leading-tight focus:outline-none focus:ring-2 focus:ring-teal-500" required>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                    <div>
                        <label for="leaveStartDate" class="block text-slate-600 text-sm font-bold mb-2">Start Date</label>
                        <input type="date" id="leaveStartDate" class="shadow-sm appearance-none border border-slate-300 rounded-lg w-full py-2 px-3 text-slate-700 leading-tight focus:outline-none focus:ring-2 focus:ring-teal-500" required>
                    </div>
                    <div>
                        <label for="leaveEndDate" class="block text-slate-600 text-sm font-bold mb-2">End Date</label>
                        <input type="date" id="leaveEndDate" class="shadow-sm appearance-none border border-slate-300 rounded-lg w-full py-2 px-3 text-slate-700 leading-tight focus:outline-none focus:ring-2 focus:ring-teal-500" required>
                    </div>
                </div>
                 <div class="flex items-center justify-end space-x-3">
                    <button type="button" id="cancelLeave" class="bg-slate-100 hover:bg-slate-200 text-slate-700 font-bold py-2 px-4 rounded-lg transition-colors">Cancel</button>
                    <button type="submit" class="bg-teal-500 hover:bg-teal-600 text-white font-bold py-2 px-4 rounded-lg shadow-lg shadow-teal-500/30">Save Leave</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Custom Alert Modal -->
    <div id="alertModal" class="modal fixed inset-0 bg-black bg-opacity-60 items-center justify-center z-50 p-4">
        <div class="bg-white rounded-xl shadow-2xl p-8 w-full max-w-sm m-4 text-center transform transition-transform scale-95">
            <div id="alertIcon" class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100 mb-5">
                 <i class="fas fa-exclamation-triangle text-2xl text-red-600"></i>
            </div>
            <h3 id="alertTitle" class="text-lg leading-6 font-bold text-slate-900">Error</h3>
            <div class="mt-2">
                <p id="alertMessage" class="text-sm text-slate-500">Something went wrong.</p>
            </div>
            <div class="mt-6">
                <button type="button" id="alertOkBtn" class="w-full inline-flex justify-center rounded-lg border border-transparent shadow-sm px-4 py-2 bg-indigo-600 text-base font-medium text-white hover:bg-indigo-700 focus:outline-none sm:text-sm">
                    OK
                </button>
            </div>
        </div>
    </div>


    <script type="module">
        // Firebase Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, doc, addDoc, onSnapshot, updateDoc, deleteDoc, query, where, getDoc, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- App Configuration ---
       const firebaseConfig = {
                  apiKey: "AIzaSyCphxL0AvlUSEKYGtM5br2_HXmoFgoRALc",
                  authDomain: "my-team-tracker-f3a8f.firebaseapp.com",
                  projectId: "my-team-tracker-f3a8f",
                  storageBucket: "my-team-tracker-f3a8f.firebasestorage.app",
                  messagingSenderId: "877508533170",
                  appId: "1:877508533170:web:12385c3dbd7435f473e2ab",
                  measurementId: "G-HPZVMR8TVN"
                };
        const appId = 'aesthetic-task-tracker-v2';

        // --- Firebase Initialization ---
        let db;
        try {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
        } catch (e) {
            console.error("Firebase initialization failed. Please check your firebaseConfig.", e);
            alert("Configuration Error: Could not initialize the database. Please check the Firebase configuration in the HTML file.");
        }

        // --- Global State ---
        let currentUserId = null;
        let teamMembers = [];
        let tasksUnsubscribe = null;
        let leavesUnsubscribe = null;
        let currentWeekStartDate = getStartOfWeek(new Date());
        let currentCalendarDate = new Date();
        let weeklyTasks = []; 
        let allLeaves = [];
        
        // --- App Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            if (!db) return; 
            initializeUser();
            setupEventListeners();
            loadTeamMembers();
            updateWeekView();
            loadLeaves();
        });

        // --- User Initialization ---
        function initializeUser() {
            let userId = localStorage.getItem('taskTrackerUserId-v2');
            if (!userId) {
                userId = `User-${Math.floor(1000 + Math.random() * 9000)}`;
                localStorage.setItem('taskTrackerUserId-v2', userId);
            }
            currentUserId = userId;
            userIdDisplay.textContent = currentUserId;
        }

        function editUserId() {
            const newUserId = prompt("Enter your name or a new User ID:", currentUserId);
            if (newUserId && newUserId.trim() !== "") {
                currentUserId = newUserId.trim();
                localStorage.setItem('taskTrackerUserId-v2', currentUserId);
                userIdDisplay.textContent = currentUserId;
                if (!teamMembers.find(m => m.name === currentUserId)) {
                    addTeamMember(currentUserId);
                }
                updateWeekView();
            }
        }

        // --- Firestore Collections ---
        const getTasksCollection = () => collection(db, `apps/${appId}/tasks`);
        const getLeavesCollection = () => collection(db, `apps/${appId}/leaves`);
        const getTeamCollection = () => collection(db, `apps/${appId}/team`);

        // --- Event Listeners ---
        function setupEventListeners() {
            document.getElementById('editUserIdBtn').addEventListener('click', editUserId);
            document.querySelectorAll('.tab-button').forEach(button => button.addEventListener('click', () => switchTab(button.dataset.tab)));
            document.getElementById('addTaskBtn').addEventListener('click', () => openTaskModal(null));
            document.getElementById('addLeaveBtn').addEventListener('click', () => openModal('leave'));
            document.getElementById('manageTeamBtn').addEventListener('click', () => openModal('team'));
            document.getElementById('cancelTask').addEventListener('click', () => closeModal('task'));
            document.getElementById('cancelLeave').addEventListener('click', () => closeModal('leave'));
            document.getElementById('closeTeamModal').addEventListener('click', () => closeModal('team'));
            document.getElementById('alertOkBtn').addEventListener('click', () => closeModal('alert'));
            document.getElementById('taskForm').addEventListener('submit', handleTaskFormSubmit);
            document.getElementById('leaveForm').addEventListener('submit', handleLeaveFormSubmit);
            document.getElementById('addTeamMemberForm').addEventListener('submit', handleAddTeamMember);
            document.getElementById('teamMemberList').addEventListener('click', handleDeleteTeamMember);
            document.getElementById('prevWeekBtn').addEventListener('click', () => { currentWeekStartDate.setDate(currentWeekStartDate.getDate() - 7); updateWeekView(); });
            document.getElementById('nextWeekBtn').addEventListener('click', () => { currentWeekStartDate.setDate(currentWeekStartDate.getDate() + 7); updateWeekView(); });
            document.getElementById('prevMonthBtn').addEventListener('click', () => { currentCalendarDate.setMonth(currentCalendarDate.getMonth() - 1); renderCalendar(); });
            document.getElementById('nextMonthBtn').addEventListener('click', () => { currentCalendarDate.setMonth(currentCalendarDate.getMonth() + 1); renderCalendar(); });
            taskGrid.addEventListener('click', handleTaskGridClick);
            document.getElementById('exportExcelBtn').addEventListener('click', exportToExcel);
            document.getElementById('exportLeavesBtn').addEventListener('click', exportLeavesToExcel);
        }
        
        // --- Modal Controls ---
        function openModal(type) {
            const modal = document.getElementById(`${type}Modal`);
            if (modal) {
                modal.classList.add('active');
                setTimeout(() => {
                    const innerDiv = modal.querySelector('div');
                    if(innerDiv) innerDiv.classList.remove('scale-95');
                }, 10);
            }
        }

        function closeModal(type) {
            const modal = document.getElementById(`${type}Modal`);
            if (modal) {
                const innerDiv = modal.querySelector('div');
                if(innerDiv) innerDiv.classList.add('scale-95');
                setTimeout(() => modal.classList.remove('active'), 200);
            }
        }

        // --- Tab Switching ---
        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.querySelectorAll('.tab-button').forEach(b => {
                b.classList.remove('active-tab', 'text-indigo-600', 'border-indigo-500');
                b.classList.add('text-slate-500', 'border-transparent');
                b.querySelector('i').classList.remove('text-indigo-500');
                b.querySelector('i').classList.add('text-slate-400');
            });
            document.getElementById(`${tabName}-content`).classList.add('active');
            const button = document.querySelector(`.tab-button[data-tab="${tabName}"]`);
            button.classList.add('active-tab', 'text-indigo-600', 'border-indigo-500');
            button.querySelector('i').classList.add('text-indigo-500');
        }

        // --- Date & Week Helpers ---
        function getStartOfWeek(d) { const date = new Date(d); const day = date.getDay(); const diff = date.getDate() - day + (day === 0 ? -6 : 1); return new Date(date.setDate(diff)); }
        function formatDate(date) { const year = date.getFullYear(); const month = (date.getMonth() + 1).toString().padStart(2, '0'); const day = date.getDate().toString().padStart(2, '0'); return `${year}-${month}-${day}`; }

        function updateWeekView() {
            if (!currentUserId) return;
            const weekStart = new Date(currentWeekStartDate);
            const weekEnd = new Date(weekStart); weekEnd.setDate(weekEnd.getDate() + 6);
            document.getElementById('weekRangeDisplay').textContent = `${weekStart.toLocaleDateString(undefined, { month: 'short', day: 'numeric' })} - ${weekEnd.toLocaleDateString(undefined, { month: 'short', day: 'numeric' })}`;
            loadTasksForWeek(weekStart, weekEnd);
        }

        // --- Task Management ---
        function loadTasksForWeek(startDate, endDate) {
            if (tasksUnsubscribe) tasksUnsubscribe();
            const q = query(getTasksCollection(), where("taskDate", ">=", formatDate(startDate)), where("taskDate", "<=", formatDate(endDate)));
            tasksUnsubscribe = onSnapshot(q, (snapshot) => {
                weeklyTasks = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderTaskGrid(weeklyTasks, startDate);
            }, (error) => { console.error("Error fetching tasks:", error); showAlert("Data Error", "Could not load tasks. Check your Firebase configuration and security rules."); });
        }

        function renderTaskGrid(tasks, weekStartDate) {
            taskGrid.innerHTML = '';
            const tasksByAssignee = tasks.reduce((acc, task) => { (acc[task.assignee || 'Unassigned'] = acc[task.assignee || 'Unassigned'] || []).push(task); return acc; }, {});
            const assignees = Object.keys(tasksByAssignee).sort();
            document.getElementById('no-tasks-message').style.display = assignees.length === 0 ? 'block' : 'none';
            taskGrid.parentElement.style.display = assignees.length > 0 ? 'block' : 'none';
            let headerHtml = '<div class="grid-header assignee-cell bg-slate-50 p-3 text-sm font-semibold text-slate-600 text-left border-slate-200">Assignee</div>';
            const days = Array.from({ length: 7 }, (_, i) => new Date(weekStartDate.getFullYear(), weekStartDate.getMonth(), weekStartDate.getDate() + i));
            days.forEach(day => { headerHtml += `<div class="grid-header bg-slate-50 p-3 text-sm font-semibold text-slate-600 text-center border-slate-200">${day.toLocaleDateString('en-US', { weekday: 'short' })}<br><span class="font-normal text-slate-500">${day.getDate()}</span></div>`; });
            taskGrid.innerHTML = headerHtml;
            assignees.forEach(assignee => {
                let rowHtml = `<div class="assignee-cell bg-white p-3 font-semibold text-slate-700 border-b border-r border-slate-200">${assignee}</div>`;
                days.forEach(day => {
                    const dayString = formatDate(day);
                    const tasksForDay = (tasksByAssignee[assignee] || []).filter(t => t.taskDate === dayString);
                    rowHtml += `<div class="p-2 border-b border-slate-200 space-y-2">`;
                    tasksForDay.forEach(task => {
                        const statusColors = {"To Do": "border-amber-400", "In Progress": "border-blue-400", "Done": "border-green-400"};
                        rowHtml += `
                            <div class="task-card group bg-white p-3 rounded-lg shadow-sm border-l-4 ${statusColors[task.status]}" data-id="${task.id}">
                                <div class="flex justify-between items-center mb-1">
                                    <span class="text-xs font-semibold text-slate-500">${task.category}</span>
                                    <div class="flex items-center space-x-2 opacity-0 group-hover:opacity-100 transition-opacity">
                                        <button data-action="edit" class="text-slate-400 hover:text-indigo-600"><i class="fas fa-pencil-alt fa-xs pointer-events-none"></i></button>
                                        <button data-action="delete" class="text-slate-400 hover:text-red-600"><i class="fas fa-trash-alt fa-xs pointer-events-none"></i></button>
                                    </div>
                                </div>
                                <p class="text-sm font-medium text-slate-800">${task.description}</p>
                            </div>
                        `;
                    });
                    rowHtml += `</div>`;
                });
                taskGrid.innerHTML += rowHtml;
            });
        }

        async function handleTaskFormSubmit(e) {
            e.preventDefault();
            if (!currentUserId) return showAlert("Error", "Could not identify user.");
            const taskId = document.getElementById('taskId').value;
            const taskData = { description: document.getElementById('taskDescription').value, assignee: document.getElementById('taskAssignee').value, status: document.getElementById('taskStatus').value, taskDate: document.getElementById('taskDate').value, category: document.getElementById('taskCategory').value, updatedBy: currentUserId, updatedAt: new Date().toISOString() };
            try {
                if (taskId) await updateDoc(doc(getTasksCollection(), taskId), taskData);
                else await addDoc(getTasksCollection(), { ...taskData, createdBy: currentUserId, createdAt: new Date().toISOString() });
                closeModal('task');
            } catch (error) { console.error("Error saving task:", error); showAlert("Save Error", "Failed to save the task. Check Firebase rules."); }
        }
        
        async function handleTaskGridClick(e) {
            const button = e.target.closest('button');
            if (!button) return;
            const taskCard = button.closest('[data-id]');
            if (!taskCard) return;
            const action = button.dataset.action;
            const taskId = taskCard.dataset.id;
            if (action === 'edit') {
                const taskSnap = await getDoc(doc(getTasksCollection(), taskId));
                if (taskSnap.exists()) openTaskModal({ id: taskSnap.id, ...taskSnap.data() });
            } else if (action === 'delete' && confirm('Are you sure you want to delete this task?')) {
                try { await deleteDoc(doc(getTasksCollection(), taskId)); } 
                catch (error) { showAlert("Delete Error", "Failed to delete task."); }
            }
        }

        function openTaskModal(task = null) {
            const form = document.getElementById('taskForm');
            form.reset();
            populateAssigneeDropdown();
            document.getElementById('taskModalTitle').textContent = task ? 'Edit Task' : 'Add New Task';
            document.getElementById('taskId').value = task ? task.id : '';
            document.getElementById('taskDescription').value = task ? task.description : '';
            document.getElementById('taskAssignee').value = task ? task.assignee : currentUserId;
            document.getElementById('taskStatus').value = task ? task.status : 'To Do';
            document.getElementById('taskDate').value = task ? task.taskDate : formatDate(new Date());
            document.getElementById('taskCategory').value = task ? task.category : 'Task';
            openModal('task');
        }
        
        // --- Team Management ---
        function loadTeamMembers() {
            const q = query(getTeamCollection(), orderBy("name"));
            onSnapshot(q, (snapshot) => {
                teamMembers = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                populateAssigneeDropdown();
                renderTeamList();
            });
        }

        function populateAssigneeDropdown() {
            const assigneeSelect = document.getElementById('taskAssignee');
            const currentVal = assigneeSelect.value;
            assigneeSelect.innerHTML = '<option value="">Select Assignee</option>';
            teamMembers.forEach(member => {
                const option = document.createElement('option');
                option.value = member.name;
                option.textContent = member.name;
                assigneeSelect.appendChild(option);
            });
            assigneeSelect.value = teamMembers.some(m => m.name === currentVal) ? currentVal : currentUserId;
        }

        function renderTeamList() {
            const listElement = document.getElementById('teamMemberList');
            listElement.innerHTML = '';
            if (teamMembers.length === 0) {
                listElement.innerHTML = `<p class="text-slate-400 text-center text-sm">No team members added yet.</p>`;
                return;
            }
            teamMembers.forEach(member => {
                const memberEl = document.createElement('div');
                memberEl.className = 'flex justify-between items-center bg-slate-50 p-2 rounded-lg';
                memberEl.dataset.id = member.id;
                memberEl.innerHTML = `
                    <span class="font-medium text-slate-700">${member.name}</span>
                    <button class="delete-member-btn text-red-400 hover:text-red-600 p-1">
                        <i class="fas fa-trash-alt pointer-events-none"></i>
                    </button>
                `;
                listElement.appendChild(memberEl);
            });
        }

        async function handleAddTeamMember(e) {
            e.preventDefault();
            const nameInput = document.getElementById('newTeamMemberName');
            const newName = nameInput.value.trim();
            if (newName) {
                await addTeamMember(newName);
                nameInput.value = '';
            }
        }

        async function addTeamMember(name) {
             if (teamMembers.find(m => m.name.toLowerCase() === name.toLowerCase())) {
                showAlert("Duplicate", `Team member "${name}" already exists.`);
                return;
            }
            try {
                await addDoc(getTeamCollection(), { name: name });
            } catch (error) {
                console.error("Error adding team member:", error);
                showAlert("Error", "Could not add team member.");
            }
        }

        async function handleDeleteTeamMember(e) {
            const deleteBtn = e.target.closest('.delete-member-btn');
            if (!deleteBtn) return;
            const memberRow = deleteBtn.closest('[data-id]');
            if (!memberRow) return;
            const memberId = memberRow.dataset.id;
            if (confirm("Are you sure you want to remove this team member?")) {
                try {
                    await deleteDoc(doc(getTeamCollection(), memberId));
                } catch (error) {
                    console.error("Error deleting team member:", error);
                    showAlert("Error", "Could not remove team member.");
                }
            }
        }
        
        // --- Leave Management & Other Utilities ---
        function loadLeaves() {
            if (leavesUnsubscribe) leavesUnsubscribe();
            const q = query(getLeavesCollection(), orderBy("startDate"));
            leavesUnsubscribe = onSnapshot(q, (snapshot) => {
                allLeaves = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderCalendar();
            }, (error) => { console.error("Error fetching leaves:", error); });
        }

        function renderCalendar() {
            const calendarEl = document.getElementById('leaveCalendar');
            if(!calendarEl) return;
            calendarEl.innerHTML = '';
            const month = currentCalendarDate.getMonth();
            const year = currentCalendarDate.getFullYear();
            document.getElementById('currentMonthYear').textContent = `${currentCalendarDate.toLocaleString('default', { month: 'long' })} ${year}`;
            const firstDayOfMonth = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].forEach(day => calendarEl.innerHTML += `<div class="font-bold text-sm text-slate-500 py-2">${day}</div>`);
            for (let i = 0; i < firstDayOfMonth; i++) calendarEl.innerHTML += '<div></div>';
            for (let day = 1; day <= daysInMonth; day++) {
                const dayEl = document.createElement('div');
                dayEl.className = 'calendar-day border border-slate-200 rounded-lg p-1 text-left relative';
                const date = new Date(year, month, day);
                const leavesOnThisDay = (allLeaves || []).filter(l => new Date(l.startDate.replace(/-/g, '\/')) <= date && date <= new Date(l.endDate.replace(/-/g, '\/')));
                let dayContent = `<div class="text-sm font-semibold text-slate-700 text-right pr-2 pt-1">${day}</div>`;
                if (leavesOnThisDay.length > 0) {
                    dayContent += '<div class="mt-1 space-y-1 px-1">';
                    leavesOnThisDay.forEach(leave => {
                        dayContent += `<div class="text-xs bg-teal-100 text-teal-800 p-1 rounded truncate" title="${leave.reason} - ${leave.userId}"><i class="fas fa-user-clock mr-1"></i>${leave.userId}: ${leave.reason}</div>`;
                    });
                    dayContent += '</div>';
                }
                dayEl.innerHTML = dayContent;
                calendarEl.appendChild(dayEl);
            }
        }

        async function handleLeaveFormSubmit(e) {
            e.preventDefault();
            if (!currentUserId) return showAlert("Error", "Could not identify user.");
            const startDate = document.getElementById('leaveStartDate').value;
            const endDate = document.getElementById('leaveEndDate').value;
            if (new Date(endDate) < new Date(startDate)) return showAlert("Invalid Dates", "End date cannot be before start date.");
            const leaveData = { reason: document.getElementById('leaveReason').value, startDate, endDate, userId: currentUserId, createdAt: new Date().toISOString() };
            try {
                await addDoc(getLeavesCollection(), leaveData);
                closeModal('leave');
            } catch (error) { showAlert("Save Error", "Failed to save leave plan."); }
        }

        function exportToExcel() {
            if (weeklyTasks.length === 0) return showAlert("No Data", "No tasks to export.");
            const tasksByAssignee = weeklyTasks.reduce((acc, task) => { (acc[task.assignee || 'Unassigned'] = acc[task.assignee || 'Unassigned'] || []).push(task); return acc; }, {});
            const assignees = Object.keys(tasksByAssignee).sort();
            const header = ["Assignee"];
            const days = Array.from({ length: 7 }, (_, i) => new Date(currentWeekStartDate.getFullYear(), currentWeekStartDate.getMonth(), currentWeekStartDate.getDate() + i));
            days.forEach(day => header.push(day.toLocaleDateString('en-US', { weekday: 'long', month: 'short', day: 'numeric' })));
            const data = assignees.map(assignee => {
                const row = [assignee];
                days.forEach(day => {
                    const dayString = formatDate(day);
                    const tasksForDay = (tasksByAssignee[assignee] || []).filter(t => t.taskDate === dayString).map(t => `[${t.category}] ${t.description} (${t.status})`).join("\n");
                    row.push(tasksForDay);
                });
                return row;
            });
            const ws = XLSX.utils.aoa_to_sheet([header, ...data]);
            ws['!cols'] = [{ wch: 25 }, ...Array(7).fill({ wch: 40 })];
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Weekly Task Report");
            XLSX.writeFile(wb, `Task_Report_Week_Of_${formatDate(currentWeekStartDate)}.xlsx`);
        }

        function exportLeavesToExcel() {
            const month = currentCalendarDate.getMonth();
            const year = currentCalendarDate.getFullYear();

            const leavesInMonth = allLeaves.filter(leave => {
                const startDate = new Date(leave.startDate.replace(/-/g, '\/'));
                return startDate.getMonth() === month && startDate.getFullYear() === year;
            });

            if (leavesInMonth.length === 0) {
                showAlert("No Data", "There are no leave plans in the current month to export.");
                return;
            }

            const dataForSheet = leavesInMonth.map(leave => ({
                "Team Member": leave.userId,
                "Reason": leave.reason,
                "Start Date": leave.startDate,
                "End Date": leave.endDate
            }));

            const ws = XLSX.utils.json_to_sheet(dataForSheet);
            ws['!cols'] = [{ wch: 25 }, { wch: 30 }, { wch: 15 }, { wch: 15 }];
            
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Monthly Leave Report");

            const monthName = currentCalendarDate.toLocaleString('default', { month: 'long' });
            const fileName = `Leave_Report_${monthName}_${year}.xlsx`;
            XLSX.writeFile(wb, fileName);
        }
        
        function showAlert(title, message) { 
            document.getElementById('alertTitle').textContent = title; 
            document.getElementById('alertMessage').textContent = message; 
            openModal('alert'); 
        }

    </script>
</body>
</html>
